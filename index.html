<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CS 1.6 WebGL</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', sans-serif; user-select: none; }
        
        /* Прицел как в CS 1.6 */
        #crosshair {
            position: absolute; top: 50%; left: 50%;
            width: 0; height: 0;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        /* Линии прицела */
        .ch-line { position: absolute; background-color: #0f0; }
        .ch-h { width: 14px; height: 2px; left: -7px; top: -1px; }
        .ch-v { width: 2px; height: 14px; left: -1px; top: -7px; }

        /* Интерфейс */
        #hud {
            position: absolute; bottom: 10px; width: 100%;
            display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box;
            color: #ffcc00; font-weight: bold; font-size: 24px; pointer-events: none;
            text-shadow: 2px 2px 0 #000;
        }
        #msg {
            position: absolute; top: 40%; width: 100%; text-align: center;
            color: white; background: rgba(0,0,0,0.5); font-size: 20px; padding: 10px;
        }
    </style>
</head>
<body>

    <!-- Прицел -->
    <div id="crosshair">
        <div class="ch-line ch-h"></div>
        <div class="ch-line ch-v"></div>
    </div>

    <!-- Сообщения -->
    <div id="msg">Кликни, чтобы играть</div>

    <!-- HUD -->
    <div id="hud">
        <div id="health">+ 100</div>
        <div id="ammo"><span id="ammo-val">30</span> / 90</div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // === ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ===
        let camera, scene, renderer, controls;
        let weapon, bulletModel;
        let bullets = [];
        let bots = []; // Массив врагов и друзей
        
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let prevTime = performance.now();
        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();

        let ammo = 30;
        let isReloading = false;

        // Позиция как в CS 1.6 (справа сбоку)
        // X: Вправо, Y: Вниз, Z: Вперед от камеры
        const WEAPON_POS = { x: 0.5, y: -0.6, z: -1.0 }; 

        init();
        animate();

        function init() {
            // 1. СЦЕНА
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x88CCFF); // Светлое небо
            // Пол (Dust style)
            const floorGeo = new THREE.PlaneGeometry(100, 100);
            const floorMat = new THREE.MeshStandardMaterial({ color: 0xDDCBAA }); // Песочный цвет
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            // Стены (для ориентации)
            const wallGeo = new THREE.BoxGeometry(10, 5, 10);
            const wallMat = new THREE.MeshStandardMaterial({ color: 0xCCBB99 });
            const box = new THREE.Mesh(wallGeo, wallMat);
            box.position.set(0, 2.5, -20);
            scene.add(box);

            // 2. КАМЕРА
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.y = 1.6; // Рост игрока

            // 3. СВЕТ
            const ambient = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambient);
            const sun = new THREE.DirectionalLight(0xffffff, 1.5);
            sun.position.set(10, 20, 10);
            scene.add(sun);

            // 4. ЗАГРУЗКА МОДЕЛЕЙ
            const loader = new GLTFLoader();

            // -- ОРУЖИЕ --
            loader.load('ark47.glb', function (gltf) {
                weapon = gltf.scene;
                camera.add(weapon);
                
                // НАСТРОЙКИ CS 1.6
                weapon.position.set(WEAPON_POS.x, WEAPON_POS.y, WEAPON_POS.z);
                weapon.rotation.set(0, Math.PI, 0); // Дуло вперед
                weapon.scale.set(15.0, 15.0, 15.0); // ОЧЕНЬ БОЛЬШОЕ

            }, undefined, function(e) { console.error("Ошибка ARK47:", e); });

            // -- ПУЛЯ --
            loader.load('pyli.glb', function (gltf) {
                bulletModel = gltf.scene;
                bulletModel.scale.set(2, 2, 2); // Размер пули
            }, undefined, function(e) { console.error("Ошибка PYLI:", e); });

            // 5. СОЗДАНИЕ БОТОВ (ЦИЛИНДРЫ)
            createBots();

            // 6. УПРАВЛЕНИЕ
            controls = new PointerLockControls(camera, document.body);
            document.addEventListener('click', () => {
                if(!controls.isLocked) {
                    controls.lock();
                    document.getElementById('msg').style.display = 'none';
                } else {
                    shoot(); // Если уже захвачен курсор - стреляем
                }
            });

            renderer = new THREE.WebGLRenderer({ antialias: false }); // False для стиля "ретро"
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Клавиши
            document.addEventListener('keydown', (e) => onKey(e, true));
            document.addEventListener('keyup', (e) => onKey(e, false));
            document.addEventListener('keydown', (e) => { if(e.code === 'KeyR') reload(); });
        }

        function createBots() {
            // Создаем 5 врагов (Красные)
            for(let i=0; i<5; i++) {
                spawnBot(0xff0000, 'enemy', -10 + i*5, -20);
            }
            // Создаем 3 тимейтов (Синие)
            for(let i=0; i<3; i++) {
                spawnBot(0x0000ff, 'friend', -5 + i*5, 5);
            }
        }

        function spawnBot(color, type, x, z) {
            const geometry = new THREE.CylinderGeometry(0.5, 0.5, 1.8, 16);
            const material = new THREE.MeshStandardMaterial({ color: color });
            const bot = new THREE.Mesh(geometry, material);
            
            bot.position.set(x, 0.9, z); // Высота цилиндра
            bot.userData = { type: type, hp: 100 }; // Данные бота
            
            scene.add(bot);
            bots.push(bot);
        }

        function shoot() {
            if(isReloading || ammo <= 0 || !weapon) return;
            
            ammo--;
            document.getElementById('ammo-val').innerText = ammo;

            // Анимация отдачи
            weapon.position.z += 0.2;
            weapon.rotation.z += 0.05;
            
            // Создание пули
            if(bulletModel) {
                const bullet = bulletModel.clone();
                // Ставим пулю на позицию камеры (из глаз)
                bullet.position.copy(camera.position);
                // Сдвигаем чуть вперед и вправо (типа из ствола)
                bullet.position.add(camera.getWorldDirection(new THREE.Vector3()).multiplyScalar(1.0));
                
                // Направление полета
                bullet.userData.velocity = camera.getWorldDirection(new THREE.Vector3()).multiplyScalar(2.0); // Скорость
                
                // Поворот пули по направлению камеры
                bullet.quaternion.copy(camera.quaternion);

                scene.add(bullet);
                bullets.push(bullet);
            }
        }

        function reload() {
            if(isReloading) return;
            isReloading = true;
            document.getElementById('ammo-val').innerText = "--";
            
            // Опускаем оружие
            if(weapon) weapon.rotation.x = -1;

            setTimeout(() => {
                ammo = 30;
                isReloading = false;
                document.getElementById('ammo-val').innerText = 30;
                if(weapon) weapon.rotation.x = 0;
            }, 2000);
        }

        function onKey(e, isDown) {
            switch (e.code) {
                case 'KeyW': moveForward = isDown; break;
                case 'KeyA': moveLeft = isDown; break;
                case 'KeyS': moveBackward = isDown; break;
                case 'KeyD': moveRight = isDown; break;
            }
        }

        function animate() {
            requestAnimationFrame(animate);

            const time = performance.now();
            if (controls.isLocked) {
                const delta = (time - prevTime) / 1000;

                // Движение игрока
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;
                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize();

                if (moveForward || moveBackward) velocity.z -= direction.z * 50.0 * delta; // Скорость CS
                if (moveLeft || moveRight) velocity.x -= direction.x * 50.0 * delta;

                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);

                // Логика Пуль
                for (let i = bullets.length - 1; i >= 0; i--) {
                    const b = bullets[i];
                    b.position.add(b.userData.velocity); // Летит вперед

                    // Проверка попаданий
                    for (let j = bots.length - 1; j >= 0; j--) {
                        const bot = bots[j];
                        // Простая проверка дистанции (попал или нет)
                        if (b.position.distanceTo(bot.position) < 1.0) {
                            scene.remove(bot); // Удаляем бота
                            bots.splice(j, 1);
                            scene.remove(b);   // Удаляем пулю
                            bullets.splice(i, 1);
                            break; // Выход из цикла ботов
                        }
                    }

                    // Удаление пули если улетела далеко
                    if (b.position.distanceTo(camera.position) > 100) {
                        scene.remove(b);
                        bullets.splice(i, 1);
                    }
                }

                // Возврат оружия после отдачи
                if(weapon && !isReloading) {
                    weapon.position.z = THREE.MathUtils.lerp(weapon.position.z, WEAPON_POS.z, 0.2);
                    weapon.rotation.z = THREE.MathUtils.lerp(weapon.rotation.z, 0, 0.2);
                }
            }
            prevTime = time;
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
